FROM rustembedded/cross:aarch64-unknown-linux-gnu-0.2.1
ENV LD_LIBRARY_PATH=/build/install/lib/
ENV OpenCV_DIR=/build/install/
ENV PKG_CONFIG_PATH=/usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/share/pkgconfig
ENV PKG_CONFIG_LIBDIR=/usr/lib/arm-linux-gnueabihf/pkgconfig:/usr/share/pkgconfig
RUN dpkg --add-architecture armhf && \
    apt-get update && \
    apt-get install --assume-yes g++-arm-linux-gnueabihf gcc-arm-linux-gnueabihf cmake libtiff-dev:armhf zlib1g-dev:armhf libjpeg-dev:armhf libpng-dev:armhf  libavcodec-dev:armhf libavformat-dev:armhf libswscale-dev:armhf libv4l-dev:armhf  libxvidcore-dev:armhf libx264-dev:armhf crossbuild-essential-armhf gfortran-arm-linux-gnueabihf && \
    touch /etc/apt/preferences.d/bionic.pref && \
    echo "deb [arch=amd64] http://us.archive.ubuntu.com/ubuntu/ bionic main restricted" >> /etc/apt/sources.list && \
    echo "Package: *" >> /etc/apt/preferences.d/bionic.pref && \
    echo "Pin: release n=xenial" >> /etc/apt/preferences.d/bionic.pref && \
    echo "Pin-Priority: -10" >> /etc/apt/preferences.d/bionic.pref && \
    echo "" >> /etc/apt/preferences.d/bionic.pref && \
    echo "Package: clang" >> /etc/apt/preferences.d/bionic.pref && \
    echo "Pin: release n=bionic" >> /etc/apt/preferences.d/bionic.pref && \
    echo "Pin-Priority: 500" >> /etc/apt/preferences.d/bionic.pref && \
    echo "" >> /etc/apt/preferences.d/bionic.pref && \
    echo "Package: libclang-dev" >> /etc/apt/preferences.d/bionic.pref && \
    echo "Pin: release n=bionic" >> /etc/apt/preferences.d/bionic.pref && \
    echo "Pin-Priority: 500" >> /etc/apt/preferences.d/bionic.pref && \
    apt-get update && \
    apt-get install --assume-yes clang-6 libclang-dev && \
    git clone https://github.com/opencv/opencv.git && \
    mkdir build && \
    cd build && \
    cmake -DENABLE_VFPV3=ON -DENABLE_NEON=ON -DCMAKE_TOOLCHAIN_FILE=../opencv/platforms/linux/arm-gnueabi.toolchain.cmake ../opencv && \ 
    #-DCMAKE_BUILD_TYPE=RELEASE
    make -j4 && \
    make install
    #cat ../opencv/platforms/linux/arm-gnueabi.toolchain.cmake
